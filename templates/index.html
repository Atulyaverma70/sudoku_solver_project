<!DOCTYPE html>
<html>
<head>
    <title>Sudoku Solver</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Sudoku Solver</h1>
        <p class="instructions">
            You can solve this problem using two methods:<br>
            1Ô∏è‚É£ Upload an image of the Sudoku puzzle.<br>
            2Ô∏è‚É£ Enter numbers directly into the grid.
        </p>

        <div class="grid-container">
            <table id="sudokuGrid"></table>
        </div>

        <div class="controls">
            <input type="file" id="sudokuImage" accept="image/*" hidden>
            <button class="btn upload-btn" onclick="document.getElementById('sudokuImage').click()">üì∑ Upload Image</button>
            <button class="btn solve-btn" onclick="solveSudoku()">üß© Solve</button>
            <button class="btn clear-btn" onclick="clearGrid()">‚ùå Clear</button>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        // Auto-detect API URL for local vs production
        const API_BASE = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
            ? "" // local dev, served by Flask
            : "https://api.yourdomain.com"; // replace with your actual AWS API endpoint

        function createGrid() {
            const grid = document.getElementById('sudokuGrid');
            for (let i = 0; i < 9; i++) {
                const row = grid.insertRow();
                for (let j = 0; j < 9; j++) {
                    const cell = row.insertCell();
                    cell.className = `${j % 3 === 2 ? 'thick-right' : ''} ${i % 3 === 2 ? 'thick-bottom' : ''}`;
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = 0;
                    input.max = 9;
                    input.addEventListener('input', validateInput);
                    cell.appendChild(input);
                }
            }
        }

        function validateInput(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = value.slice(0, 1);
        }

        async function solveSudoku() {
            showMessage('Solving...', 'info');
            const inputs = document.querySelectorAll('#sudokuGrid input');
            const grid = [];
            inputs.forEach((input, index) => {
                const row = Math.floor(index / 9);
                const col = index % 9;
                if (!grid[row]) grid[row] = [];
                grid[row][col] = input.value ? parseInt(input.value) : 0;
            });

            try {
                const response = await fetch(`${API_BASE}/solve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ grid })
                });

                const data = await response.json();
                if (response.ok && data.solved_grid) {
                    data.solved_grid.forEach((row, i) => {
                        row.forEach((num, j) => {
                            inputs[i * 9 + j].value = num || '';
                        });
                    });
                    showMessage('Sudoku solved!', 'success');
                } else {
                    showMessage(data.error || 'Failed to solve', 'error');
                }
            } catch (error) {
                showMessage('Connection error: ' + error.message, 'error');
            }
        }

        document.getElementById('sudokuImage').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showMessage('Processing image...', 'info');
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok && data.grid) {
                    const inputs = document.querySelectorAll('#sudokuGrid input');
                    inputs.forEach((input, index) => {
                        const val = data.grid[Math.floor(index / 9)][index % 9];
                        input.value = val !== 0 ? val : '';
                    });
                    showMessage('Grid extracted!', 'success');
                } else {
                    showMessage(data.error || 'Image processing failed', 'error');
                }
            } catch (error) {
                showMessage('Upload failed: ' + error.message, 'error');
            }
        });

        function clearGrid() {
            document.querySelectorAll('#sudokuGrid input').forEach(input => input.value = '');
            showMessage('', '');
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
        }

        createGrid();
    </script>
</body>
</html>
